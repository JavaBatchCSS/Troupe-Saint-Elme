<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des contacts - Troupe Saint Elme</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <img style="right:20px" src="images/embleme troupe.png">
        <img style="left:20px" src="images/logo fédération.png">
        <h1>Troupe Saint Elme</h1>
    </header>

    <main>
        <div class="documentation-section">
            <h2>Gestion des contacts</h2>
            <table id="contactsTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les contacts seront chargés ici -->
                </tbody>
            </table>
            <form id="addContactForm" class="form-group">
                <h3>Ajouter un contact</h3>
                <label>
                    Nom :
                    <input type="text" id="nameInput" required>
                </label>
                <label>
                    Email :
                    <input type="email" id="emailInput" required>
                </label>
                <button type="submit" class="btn-inscription">Ajouter</button>
            </form>
            <pre id="result"></pre>
        </div>
    </main>

    <footer>
        <p>&copy; Troupe Saint Elme</p>
    </footer>

    <script>
        const owner = "JavaBatchCSS";
        const repo = "Troupe-Saint-Elme";
        const path = "contacts.txt";
        const branch = "master";
        const token = "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";

        const contactsTable = document.getElementById("contactsTable").querySelector("tbody");
        const resultElement = document.getElementById("result");

        async function loadContacts() {
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error("Impossible de récupérer le fichier des contacts.");
                }

                const fileData = await response.json();
                const fileContent = atob(fileData.content);
                const contacts = fileContent.split("\n").filter(line => line.trim() !== "").map(line => {
                    const [name, email] = line.split(",");
                    return { name: name.trim(), email: email.trim() };
                });

                contactsTable.innerHTML = "";
                contacts.forEach(contact => {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td>${contact.name}</td><td>${contact.email}</td>`;
                    contactsTable.appendChild(row);
                });
            } catch (error) {
                resultElement.textContent = `Erreur : ${error.message}`;
            }
        }

        async function addContact(name, email) {
            try {
                const fileResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!fileResponse.ok) {
                    throw new Error("Impossible de récupérer le fichier des contacts.");
                }

                const fileData = await fileResponse.json();
                const fileContent = atob(fileData.content);
                const updatedContent = `${fileContent}\n${name},${email}`.trim();
                const encodedContent = btoa(updatedContent);

                const updateResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: `Ajout du contact : ${name}`,
                        content: encodedContent,
                        sha: fileData.sha,
                        branch: branch
                    })
                });

                if (updateResponse.ok) {
                    resultElement.textContent = `Contact ajouté avec succès : ${name} (${email}).`;
                    loadContacts();
                } else {
                    const error = await updateResponse.json();
                    resultElement.textContent = `Erreur : ${error.message}`;
                }
            } catch (error) {
                resultElement.textContent = `Erreur : ${error.message}`;
            }
        }

        document.getElementById("addContactForm").addEventListener("submit", (event) => {
            event.preventDefault();
            const name = document.getElementById("nameInput").value;
            const email = document.getElementById("emailInput").value;
            addContact(name, email);
            document.getElementById("addContactForm").reset();
        });

        loadContacts();
    </script>
</body>
</html>
