<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Contacts</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="images/embleme troupe.png">
</head>
<body>
    <!-- En-tête similaire -->
    <header>
        <img style="right:20px" src="images/embleme troupe.png">
        <img style="left:20px" src="images/logo fédération.png">
        <h1>Troupe Saint Elme</h1>
        <nav>
            <ul>
                <li><a href="index.html">Accueil</a></li>
                <li><a href="annee_2023.html">2023</a></li>
                <li><a href="annee_2024.html">2024</a></li>
                <li><a href="annee_2025.html">2025</a></li>
                <li><a href="documentation.html">Documentation</a></li>
                <li><a href="https://www.fsggb.fr/">Site de la Fédération</a></li>
            </ul>
        </nav>
    </header>

    <!-- Section principale de gestion des contacts -->
    <main>
        <section class="documentation-section">
            <h2>Gestion des Contacts</h2>
            <div class="documentation-grid">
                <form id="contactForm" class="documentation-item">
                    <label for="name">Nom :</label>
                    <input type="text" id="name" name="name" required>
                    <br>
                    <label for="email">Email :</label>
                    <input type="email" id="email" name="email" required>
                    <br>
                    <button type="submit">Ajouter/Modifier</button>
                </form>
            </div>
        </section>

        <!-- Liste des contacts -->
        <section class="documentation-section">
            <h2>Liste des Contacts</h2>
            <div id="contactList" class="documentation-grid"></div>
        </section>
    </main>

    <!-- Pied de page -->
    <footer>
        <p>&copy; Troupe Saint Elme</p>
    </footer>

    <script>
        const GITHUB_TOKEN = "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"; // Remplacez par votre token personnel
        const REPO_OWNER = "JavaBatchCSS";
        const REPO_NAME = "Troupe-Saint-Elme";
        const FILE_PATH = "contacts.txt";

        // Récupérer les contacts existants
        async function fetchContacts() {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const content = atob(data.content); // Décode Base64
                return content.split("\n").filter(line => line.trim() !== ""); // Retirer les lignes vides
            } else if (response.status === 404) {
                return []; // Si le fichier n'existe pas
            } else {
                throw new Error("Impossible de récupérer les contacts.");
            }
        }

        // Mettre à jour le fichier contact.txt
        async function updateContacts(newContacts) {
            const currentData = await fetchContacts();
            const shaResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: { Authorization: `Bearer ${GITHUB_TOKEN}` }
            });

            const sha = shaResponse.ok ? (await shaResponse.json()).sha : null;

            const updatedContent = [...currentData, ...newContacts].join("\n");

            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                method: "PUT",
                headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: "Mise à jour des contacts",
                    content: btoa(updatedContent), // Encode Base64
                    sha: sha
                })
            });

            if (!response.ok) {
                throw new Error("Échec de la mise à jour des contacts.");
            }
        }

        // Afficher les contacts
        async function displayContacts() {
            const contactList = document.getElementById("contactList");
            contactList.innerHTML = ""; // Réinitialiser la liste

            const contacts = await fetchContacts();
            contacts.forEach(contact => {
                const div = document.createElement("div");
                div.className = "documentation-item";
                div.textContent = contact;
                contactList.appendChild(div);
            });
        }

        // Gestion du formulaire
        document.getElementById("contactForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;

            try {
                await updateContacts([`${name}, ${email}`]);
                alert("Contact ajouté/modifié avec succès !");
                document.getElementById("contactForm").reset();
                displayContacts();
            } catch (error) {
                console.error(error);
                alert("Erreur lors de la mise à jour des contacts.");
            }
        });

        // Charger les contacts au démarrage
        window.onload = displayContacts;
    </script>
</body>
</html>
