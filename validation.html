<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation d'acc√®s - Troupe Saint Elme</title>
    <link rel="stylesheet" href="https://javabatchcss.github.io/Troupe-Saint-Elme/style.css">
    <link rel="icon" href="https://javabatchcss.github.io/Troupe-Saint-Elme/images/embleme troupe.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* Styles sp√©cifiques √† la page de validation */
        .validation-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
        }
        
        .validation-container h1 {
            color: #3498db;
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .demande-details {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .demande-details p {
            margin: 10px 0;
            font-size: 16px;
        }
        
        .strong {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .btn {
            border: none;
            border-radius: 30px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 48%;
        }
        
        .btn-accepter {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-accepter:hover {
            background-color: #27ae60;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-refuser {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-refuser:hover {
            background-color: #c0392b;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Formulaires pour les emails */
        .formulaire-email {
            display: none;
            margin-top: 20px;
        }
        
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <header>
        <img style="right:20px" src="https://javabatchcss.github.io/Troupe-Saint-Elme/images/embleme troupe.png">
        <img style="left:20px" src="https://javabatchcss.github.io/Troupe-Saint-Elme/images/logo f√©d√©ration.png">
        <h1>Troupe Saint Elme</h1>
    </header>
    
    <main>
        <div class="validation-container">
            <h1>Validation de demande d'acc√®s</h1>
            <div id="messageBox" class="message"></div>
            
            <div class="demande-details">
                <h2>Informations de la demande</h2>
                <p><span class="strong">Nom:</span> <span id="nom"></span></p>
                <p><span class="strong">Pr√©nom:</span> <span id="prenom"></span></p>
                <p><span class="strong">Email:</span> <span id="email"></span></p>
                <p id="row-telephone"><span class="strong">T√©l√©phone:</span> <span id="telephone"></span></p>
                <p><span class="strong">Mot de passe:</span> <span id="motdepasse"></span></p>
                <p><span class="strong">Date de la demande:</span> <span id="date"></span></p>
                <p id="id-genere-section" style="display:none;"><span class="strong">ID g√©n√©r√©:</span> <span id="id-genere"></span></p>
                <div id="permission-section" style="margin-top:20px;text-align:center;">
                    <label style="font-weight:bold;">Permission √† accorder :</label>
                    <select id="permission-select" style="margin-left:10px;padding:6px 12px;border-radius:6px;">
                       <option value="visiteur">Simple visiteur</option>
                       <option value="admin">Administrateur</option>
                    </select>
                </div>
            </div>
            
            

            <div class="actions">
                <button id="btnAccepter" class="btn btn-accepter">Accepter</button>
                <button id="btnRefuser" class="btn btn-refuser">Refuser</button>
            </div>
        </div>
    </main>
    
    <footer>
        <p>&copy; Troupe Saint Elme</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        
        // --- Utilitaires URL ---
        function getParametreUrl(param) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            return urlParams.get(param);
        }

        // --- Affichage des infos de la demande ---
        let nom = getParametreUrl('nom') || '';
        let prenom = getParametreUrl('prenom') || '';
        let email = getParametreUrl('email') || '';
        let password = getParametreUrl('password') || '';
        let date = getParametreUrl('date') || new Date().toLocaleString();
        let telephone = getParametreUrl('telephone') || '';

        // --- Affichage des infos dans la page ---
        window.onload = function() {
            // Gestion des messages de retour
            const action = getParametreUrl('action');
            if (action === 'accepte') {
                document.getElementById('messageBox').className = 'message success';
                document.getElementById('messageBox').textContent = "L'email d'acceptation a √©t√© envoy√© et le contact ajout√© √† l'annuaire.";
                document.getElementById('messageBox').style.display = 'block';
                document.querySelector('.demande-details').style.display = 'none';
                document.querySelector('.actions').style.display = 'none';
                return;
            } else if (action === 'refuse') {
                document.getElementById('messageBox').className = 'message success';
                document.getElementById('messageBox').textContent = "L'email de refus a √©t√© envoy√©.";
                document.getElementById('messageBox').style.display = 'block';
                document.querySelector('.demande-details').style.display = 'none';
                document.querySelector('.actions').style.display = 'none';
                return;
            }

            document.getElementById('nom').textContent = nom || "Non sp√©cifi√©";
            document.getElementById('prenom').textContent = prenom || "Non sp√©cifi√©";
            document.getElementById('email').textContent = email || "Non sp√©cifi√©";
            document.getElementById('telephone').textContent = telephone || "Non sp√©cifi√©";
            document.getElementById('motdepasse').textContent = password || "Non sp√©cifi√©";
            document.getElementById('date').textContent = date || "Non sp√©cifi√©";
        };

        // --- Initialisation EmailJS ---
        if (window.emailjs && typeof emailjs.init === "function") {
            emailjs.init("pXqUmmdrOccofygDq");
        }

        // Configuration s√©curis√©e (IDENTIQUE √† l'annuaire)
        const ENCRYPTION_KEY = "TroupeSaintElme2025";
        const encryptedData = {
            githubToken: "U2FsdGVkX18bflIPTYoKWYCFcJFneYp3xcwtgiHr90CLkbqlQOcfanBT7V1580l1RR5QFvZHXPxpHghmzzwUPc8pw7VN1W/Y+pOTRO0J4OfZx23zkkqmayC7/2EqfRvthq+OkDLXg1v7QsSqLjgzqQ==",
            githubOwner: "U2FsdGVkX186j9ffhpnA1a9MJtRiIa/04ShDXl5sbNQ=",
            githubRepo: "U2FsdGVkX19Zfsoi64wXtZeYZ3LTFaved+N7Qx6X6sdPw7IlmTc4/tOAKOkGPcHv",
            githubBranch: "U2FsdGVkX18dk0LRwjtJUNSytvcU62mMHrQE7rv8WUQ="
        };

        function decrypt(encryptedText) {
            try {
                if (!encryptedText || typeof encryptedText !== 'string') {
                    console.error("Texte chiffr√© invalide:", encryptedText);
                    return null;
                }
                const decrypted = CryptoJS.AES.decrypt(encryptedText, ENCRYPTION_KEY).toString(CryptoJS.enc.Utf8);
                if (!decrypted) {
                    console.error("D√©chiffrement √©chou√© pour:", encryptedText);
                    return null;
                }
                return decrypted;
            } catch (error) {
                console.error("Erreur de d√©chiffrement:", error);
                return null;
            }
        }

        function getSecureValue(key) {
            if (!encryptedData[key]) {
                console.error(`La cl√© ${key} n'existe pas dans les donn√©es s√©curis√©es`);
                return null;
            }
            return decrypt(encryptedData[key]);
        }

        // Utiliser les valeurs d√©chiffr√©es
        const GITHUB_TOKEN = getSecureValue('githubToken');
        const GITHUB_USERNAME = getSecureValue('githubOwner');
        const GITHUB_REPO = getSecureValue('githubRepo');
        const GITHUB_BRANCH = getSecureValue('githubBranch');
        const CONTACTS_FILE = "contacts.json";

        // Variables globales
        let contacts = [];
        let currentContactId = null;

        // FONCTION COPIE EXACTE DE L'ANNUAIRE
        function encryptContactData(contact) {
            try {
                return {
                    id: contact.id, // L'ID reste en clair
                    nom: CryptoJS.AES.encrypt(contact.nom || '', ENCRYPTION_KEY).toString(),
                    prenom: CryptoJS.AES.encrypt(contact.prenom || '', ENCRYPTION_KEY).toString(),
                    email: CryptoJS.AES.encrypt(contact.email || '', ENCRYPTION_KEY).toString(),
                    telephone: CryptoJS.AES.encrypt(contact.telephone || '', ENCRYPTION_KEY).toString(),
                    motdepasse: CryptoJS.AES.encrypt(contact.motdepasse || '', ENCRYPTION_KEY).toString(),
                    droits: CryptoJS.AES.encrypt(contact.droits || '', ENCRYPTION_KEY).toString()
                };
            } catch (error) {
                console.error('Erreur lors du chiffrement:', error);
                return null;
            }
        }

        // FONCTION COPIE EXACTE DE L'ANNUAIRE
        function decryptContactData(encryptedContact) {
            try {
                if (!encryptedContact || typeof encryptedContact !== 'object') {
                    console.error("Contact chiffr√© invalide:", encryptedContact);
                    return null;
                }

                const decrypted = {
                    id: encryptedContact.id,
                    nom: '',
                    prenom: '',
                    email: '',
                    telephone: '',
                    motdepasse: '',
                    droits: ''
                };

                // D√©chiffrer chaque champ individuellement avec validation
                if (encryptedContact.nom) {
                    const nom = decrypt(encryptedContact.nom);
                    if (nom !== null) decrypted.nom = nom;
                }
                if (encryptedContact.prenom) {
                    const prenom = decrypt(encryptedContact.prenom);
                    if (prenom !== null) decrypted.prenom = prenom;
                }
                if (encryptedContact.email) {
                    const email = decrypt(encryptedContact.email);
                    if (email !== null) decrypted.email = email;
                }
                if (encryptedContact.telephone) {
                    const telephone = decrypt(encryptedContact.telephone);
                    if (telephone !== null) decrypted.telephone = telephone;
                }
                if (encryptedContact.motdepasse) {
                    const motdepasse = decrypt(encryptedContact.motdepasse);
                    if (motdepasse !== null) decrypted.motdepasse = motdepasse;
                }
                if (encryptedContact.droits) {
                    const droits = decrypt(encryptedContact.droits);
                    if (droits !== null) decrypted.droits = droits;
                }

                return decrypted;
            } catch (error) {
                console.error('Erreur lors du d√©chiffrement:', error);
                return null;
            }
        }

        // FONCTION COPIE EXACTE DE L'ANNUAIRE
        function generateContactId(droits) {
            const now = new Date();
            const dateInscription = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD
            const hexRandom = Math.random().toString(16).substring(2, 8).toUpperCase(); // 6 caract√®res hex
            return `${droits.toUpperCase()}@${dateInscription}#${hexRandom}`;
        }

        // FONCTION COPIE EXACTE DE L'ANNUAIRE
        async function loadContacts() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${CONTACTS_FILE}?ref=${GITHUB_BRANCH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    let content = atob(data.content || "");
                    if (!content.trim()) {
                        contacts = [];
                    } else {
                        try {
                            const encryptedContacts = JSON.parse(content);
                            if (Array.isArray(encryptedContacts)) {
                                // D√©chiffrer chaque contact
                                contacts = encryptedContacts.map(encryptedContact => {
                                    const decrypted = decryptContactData(encryptedContact);
                                    return decrypted;
                                }).filter(contact => contact !== null && contact.id);
                            } else {
                                contacts = [];
                            }
                        } catch (e) {
                            console.error('Erreur lors du parsing JSON:', e);
                            contacts = [];
                        }
                    }
                } else if (response.status === 404) {
                    contacts = [];
                } else {
                    throw new Error(`Impossible de charger les contacts depuis GitHub: ${response.status}`);
                }
                console.log('üìä Contacts charg√©s:', contacts.length);
                return true;
            } catch (error) {
                console.error('Erreur lors du chargement des contacts:', error);
                return false;
            }
        }

        // FONCTION COPIE EXACTE DE L'ANNUAIRE (avec gestion des conflits)
        async function saveContacts(retryCount = 0) {
            const maxRetries = 3;
            
            try {
                // √âtape 1: R√©cup√©rer le SHA actuel √† chaque tentative
                const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${CONTACTS_FILE}?ref=${GITHUB_BRANCH}&t=${Date.now()}`, {
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
                });

                let sha = null;
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                }

                // √âtape 2: Chiffrer les contacts
                const encryptedContacts = contacts.map(contact => encryptContactData(contact)).filter(c => c !== null);
                const content = JSON.stringify(encryptedContacts, null, 2);

                // √âtape 3: Pr√©parer la requ√™te
                const requestData = {
                    message: `Mise √† jour annuaire - ${new Date().toISOString()}`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: GITHUB_BRANCH
                };

                if (sha) {
                    requestData.sha = sha;
                }

                // √âtape 4: Envoyer la mise √† jour
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${CONTACTS_FILE}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `token ${GITHUB_TOKEN}`
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    return true;
                } else if (response.status === 409 && retryCount < maxRetries) {
                    // Conflit de SHA - r√©essayer apr√®s un d√©lai
                    const delay = (retryCount + 1) * 1000; // 1s, 2s, 3s
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return await saveContacts(retryCount + 1);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Erreur sauvegarde:', errorData);
                    return false;
                }

            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                
                // R√©essayer en cas d'erreur r√©seau
                if (retryCount < maxRetries) {
                    const delay = (retryCount + 1) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return await saveContacts(retryCount + 1);
                }
                
                return false;
            }
        }

        // FONCTION COPIE EXACTE DE addContact DE L'ANNUAIRE - RENOMM√âE
        async function addContact() {
            const nom = nom.trim().toUpperCase();
            const prenom = prenom.trim();
            const email = email.trim();
            const telephone = telephone.trim();
            const motdepasse = password.trim();
            const droits = document.getElementById('permission-select').value;

            if (!nom || !prenom || !email || !motdepasse || !droits) {
                console.error('Champs manquants pour l\'ajout');
                return { success: false, error: 'Veuillez remplir tous les champs obligatoires.' };
            }

            const newContact = {
                id: generateContactId(droits),
                nom,
                prenom,
                email,
                telephone,
                motdepasse,
                droits
            };

            // Ajouter le contact √† la liste locale
            contacts.push(newContact);
            
            // Sauvegarder
            const saveSuccessful = await saveContacts();
            
            if (saveSuccessful) {
                console.log('‚úÖ Contact ajout√© avec succ√®s:', newContact.id);
                return { success: true, contactId: newContact.id, isUpdate: false };
            } else {
                // En cas d'√©chec, retirer le contact de la liste
                contacts = contacts.filter(c => c.id !== newContact.id);
                console.error('‚ùå √âchec sauvegarde, contact retir√© de la liste');
                return { success: false, error: 'Erreur lors de l\'ajout du contact.' };
            }
        }

        // === CONSTRUCTION DES EMAILS ===
        function buildAcceptationEmail(nom, prenom, email, lienAcces, permission) {
            return `
<table width="100%" cellpadding="0" cellspacing="0" border="0" style="font-family: Arial, sans-serif; background-color: #f8f9fa;">
    <tr>
        <td>
            <table width="100%" max-width="600px" cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto;">
                <tr>
                    <td style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; padding: 30px; text-align: center;">
                        <h1 style="margin: 0; font-size: 28px; font-weight: bold;">‚úÖ Acc√®s accord√© !</h1>
                        <h2 style="margin: 15px 0 0 0; font-size: 20px; font-weight: normal;">üèïÔ∏è Troupe Saint Elme</h2>
                    </td>
                </tr>
                
                <tr>
                    <td style="padding: 30px; background-color: white;">
                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #d4edda; padding: 25px; margin-bottom: 25px; border-left: 5px solid #2ecc71; border-radius: 8px;">
                            <tr>
                                <td>
                                    <h3 style="margin: 0 0 15px 0; color: #155724; font-size: 20px;">Bonjour ${prenom},</h3>
                                    <p style="margin: 0; color: #155724; line-height: 1.6; font-size: 16px;">F√©licitations ! Votre demande d'acc√®s au site de la Troupe Saint Elme a √©t√© <strong>accept√©e</strong>.</p>
                                </td>
                            </tr>
                        </table>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #e3f2fd; padding: 25px; margin-bottom: 25px; border-left: 5px solid #2196f3; border-radius: 8px;">
                            <tr>
                                <td>
                                    <h3 style="margin: 0 0 15px 0; color: #1565c0; font-size: 18px;">üéØ Informations de votre compte</h3>
                                    <ul style="margin: 0; padding-left: 25px; color: #1565c0; line-height: 1.6; font-size: 15px;">
                                        <li style="margin-bottom: 8px;"><strong>Nom :</strong> ${nom}</li>
                                        <li style="margin-bottom: 8px;"><strong>Pr√©nom :</strong> ${prenom}</li>
                                        <li style="margin-bottom: 8px;"><strong>Email :</strong> ${email}</li>
                                        <li style="margin-bottom: 8px;"><strong>Niveau d'acc√®s :</strong> ${permission}</li>
                                    </ul>
                                </td>
                            </tr>
                        </table>

                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #fff3cd; padding: 25px; margin-bottom: 25px; border-left: 5px solid #ffc107; border-radius: 8px;">
                            <tr>
                                <td style="text-align: center;">
                                    <h3 style="margin: 0 0 15px 0; color: #856404; font-size: 20px; font-weight: bold;">üîó Acc√©dez au site maintenant</h3>
                                    <a href="${lienAcces}" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; text-decoration: none; padding: 15px 30px; border-radius: 30px; font-weight: bold; font-size: 16px; display: inline-block; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                        üèïÔ∏è Acc√©der au site
                                    </a>
                                    <p style="margin: 15px 0 0 0; color: #856404; font-size: 14px;">Cliquez sur ce bouton pour acc√©der au site de la troupe</p>
                                </td>
                            </tr>
                        </table>

                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #d1ecf1; padding: 20px; margin-bottom: 25px; border-left: 5px solid #17a2b8; border-radius: 8px;">
                            <tr>
                                <td>
                                    <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 16px;">üìû Contact</h4>
                                    <p style="margin: 0; color: #0c5460; font-size: 14px;">Email : <a href="mailto:contact.troupesaintelme@gmail.com" style="color: #2196f3; text-decoration: none;">contact.troupesaintelme@gmail.com</a></p>
                                </td>
                            </tr>
                        </table>

                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                            <tr>
                                <td style="text-align: center; color: #6c757d; font-size: 14px; line-height: 1.5;">
                                    Bienvenue dans la communaut√© !<br>
                                    üèïÔ∏è <strong>L'√©quipe de la Troupe Saint Elme</strong><br>
                                    Groupe Beaudoin IV de J√©rusalem<br>
                                    F√©d√©ration des Scouts et Guides Godefroy de Bouillon
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>`;
        }

        function buildRefusEmail(nom, prenom, email) {
            return `
<table width="100%" cellpadding="0" cellspacing="0" border="0" style="font-family: Arial, sans-serif; background-color: #f8f9fa;">
    <tr>
        <td>
            <table width="100%" max-width="600px" cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto;">
                <tr>
                    <td style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 30px; text-align: center;">
                        <h1 style="margin: 0; font-size: 28px; font-weight: bold;">‚ùå Demande refus√©e</h1>
                        <h2 style="margin: 15px 0 0 0; font-size: 20px; font-weight: normal;">üèïÔ∏è Troupe Saint Elme</h2>
                    </td>
                </tr>
                
                <tr>
                    <td style="padding: 30px; background-color: white;">
                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f8d7da; padding: 25px; margin-bottom: 25px; border-left: 5px solid #dc3545; border-radius: 8px;">
                            <tr>
                                <td>
                                    <h3 style="margin: 0 0 15px 0; color: #721c24; font-size: 20px;">Bonjour ${prenom},</h3>
                                    <p style="margin: 0; color: #721c24; line-height: 1.6; font-size: 16px;">Nous sommes au regret de vous informer que votre demande d'acc√®s au site de la Troupe Saint Elme a √©t√© <strong>refus√©e</strong>.</p>
                                </td>
                            </tr>
                        </table>
                        
                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #fff3cd; padding: 25px; margin-bottom: 25px; border-left: 5px solid #ffc107; border-radius: 8px;">
                            <tr>
                                <td>
                                    <h3 style="margin: 0 0 15px 0; color: #856404; font-size: 18px;">üí¨ Que faire maintenant ?</h3>
                                    <p style="margin: 0; color: #856404; line-height: 1.6; font-size: 15px;">Si vous pensez qu'il s'agit d'une erreur ou si vous souhaitez obtenir plus d'informations, n'h√©sitez pas √† nous contacter directement.</p>
                                </td>
                            </tr>
                        </table>

                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #d1ecf1; padding: 20px; margin-bottom: 25px; border-left: 5px solid #17a2b8; border-radius: 8px;">
                            <tr>
                                <td>
                                    <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 16px;">üìû Contact</h4>
                                    <p style="margin: 0; color: #0c5460; font-size: 14px;">Email : <a href="mailto:contact.troupesaintelme@gmail.com" style="color: #2196f3; text-decoration: none;">contact.troupesaintelme@gmail.com</a></p>
                                </td>
                            </tr>
                        </table>

                        <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-top: 1px solid #e9ecef; padding-top: 20px;">
                            <tr>
                                <td style="text-align: center; color: #6c757d; font-size: 14px; line-height: 1.5;">
                                    Cordialement,<br>
                                    üèïÔ∏è <strong>L'√©quipe de la Troupe Saint Elme</strong><br>
                                    Groupe Beaudoin IV de J√©rusalem<br>
                                    F√©d√©ration des Scouts et Guides Godefroy de Bouillon
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>`;
        }

        // --- Gestion des boutons ---
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('btnAccepter').addEventListener('click', async function() {
                // Validation des donn√©es d'entr√©e
                if (!nom || !prenom || !email || !password) {
                    document.getElementById('messageBox').className = 'message error';
                    document.getElementById('messageBox').textContent = "‚ùå Donn√©es manquantes dans l'URL. Impossible de traiter la demande.";
                    document.getElementById('messageBox').style.display = 'block';
                    return;
                }

                // Validation configuration
                if (!GITHUB_TOKEN || !GITHUB_USERNAME || !GITHUB_REPO || !GITHUB_BRANCH) {
                    document.getElementById('messageBox').className = 'message error';
                    document.getElementById('messageBox').textContent = "‚ùå Configuration GitHub incompl√®te.";
                    document.getElementById('messageBox').style.display = 'block';
                    return;
                }

                // D√©sactiver UI
                const btnAccepter = document.getElementById('btnAccepter');
                const btnRefuser = document.getElementById('btnRefuser');
                const originalText = btnAccepter.textContent;
                
                btnAccepter.disabled = true;
                btnRefuser.disabled = true;
                btnAccepter.textContent = '‚è≥ Traitement...';

                try {
                    // CHARGER D'ABORD LES CONTACTS COMME L'ANNUAIRE
                    document.getElementById('messageBox').className = 'message info';
                    document.getElementById('messageBox').textContent = "Chargement des contacts existants...";
                    document.getElementById('messageBox').style.display = 'block';

                    const loadSuccess = await loadContacts();
                    if (!loadSuccess) {
                        throw new Error('Impossible de charger les contacts existants');
                    }

                    // R√©cup√©ration permission
                    const permission = document.getElementById('permission-select').value;
                    console.log('üéØ Param√®tres ajout:', {
                        nom, prenom, email, telephone, permission,
                        passwordLength: password.length,
                        contactsCount: contacts.length
                    });
                    
                    // Message d'enregistrement en cours EXACTEMENT comme l'annuaire
                    document.getElementById('messageBox').className = 'message info';
                    document.getElementById('messageBox').textContent = "Enregistrement en cours...";
                    document.getElementById('messageBox').style.display = 'block';
                    
                    // V√âRIFIER SI CONTACT EXISTE D√âJ√Ä (comme l'annuaire)
                    const existingContactIndex = contacts.findIndex(c => 
                        c.email && c.email.trim().toLowerCase() === email.trim().toLowerCase()
                    );

                    let contactId;
                    let isUpdate = false;

                    if (existingContactIndex !== -1) {
                        // MISE √Ä JOUR contact existant EXACTEMENT comme l'annuaire
                        contactId = contacts[existingContactIndex].id;
                        contacts[existingContactIndex] = {
                            id: contactId,
                            nom: nom.toUpperCase(),
                            prenom,
                            email,
                            telephone,
                            motdepasse: password,
                            droits: permission
                        };
                        isUpdate = true;
                        console.log(`üîÑ Contact existant mis √† jour: ${contactId}`);
                    } else {
                        // NOUVEAU contact EXACTEMENT comme l'annuaire
                        contactId = generateContactId(permission);
                        const newContact = {
                            id: contactId,
                            nom: nom.toUpperCase(),
                            prenom,
                            email,
                            telephone,
                            motdepasse: password,
                            droits: permission
                        };
                        contacts.push(newContact);
                        console.log(`‚ûï Nouveau contact cr√©√©: ${contactId}`);
                    }

                    console.log('üíæ Tentative sauvegarde avec', contacts.length, 'contacts');

                    // SAUVEGARDER EXACTEMENT comme l'annuaire
                    const saveSuccessful = await saveContacts();
                    
                    if (!saveSuccessful) {
                        // En cas d'√©chec, restaurer l'√©tat pr√©c√©dent
                        if (!isUpdate) {
                            contacts = contacts.filter(c => c.id !== contactId);
                        }
                        throw new Error('√âchec de la sauvegarde GitHub');
                    }

                    console.log('‚úÖ Sauvegarde GitHub r√©ussie pour:', contactId);
                    
                    // SUCC√àS : Afficher l'ID
                    document.getElementById('id-genere').textContent = contactId;
                    document.getElementById('id-genere-section').style.display = 'block';
                    
                    // Message de succ√®s d√©taill√©
                    const actionText = isUpdate ? 'mis √† jour' : 'ajout√©';
                    document.getElementById('messageBox').className = 'message success';
                    document.getElementById('messageBox').innerHTML = `
                        ‚úÖ <strong>CONTACT ${actionText.toUpperCase()} AVEC SUCC√àS !</strong><br>
                        üìã ID: <strong>${contactId}</strong><br>
                        üë§ Contact: <strong>${prenom} ${nom}</strong><br>
                        üìß Email: <strong>${email}</strong><br>
                        üé≠ Droits: <strong>${permission}</strong><br><br>
                        üìß Tentative d'envoi email de notification...
                    `;
                    document.getElementById('messageBox').style.display = 'block';
                    
                    // Tentative email
                    btnAccepter.textContent = 'üìß Email...';
                    
                    try {
                        const lienAcces = "https://JavaBatchCss.github.io/Troupe-Saint-Elme/site_principal.html?token=" + btoa(email + "|" + Date.now());
                        const emailContent = buildAcceptationEmail(nom, prenom, email, lienAcces, permission);
                        
                        const params = {
                            subject: `‚úÖ Acc√®s accord√© - Troupe Saint Elme`,
                            name: "Troupe Saint Elme",  
                            email: email,
                            contenu: emailContent
                        };
                        
                        await emailjs.send('contact_troupe_st_elme', 'Troupe Saint Elme', params);
                        
                        // Succ√®s complet
                        document.getElementById('messageBox').className = 'message success';
                        document.getElementById('messageBox').innerHTML = `
                            üéâ <strong>SUCC√àS COMPLET !</strong><br>
                            ‚úÖ Contact ${actionText} dans l'annuaire<br>
                            üìã ID: <strong>${contactId}</strong><br>
                            üìß Email envoy√© √†: <strong>${email}</strong><br>
                            üîÑ Redirection dans 3 secondes...
                        `;
                        document.getElementById('messageBox').style.display = 'block';
                        
                        setTimeout(() => {
                            window.location.href = window.location.pathname + "?action=accepte";
                        }, 3000);
                        
                    } catch (emailError) {
                        console.warn('‚ö†Ô∏è Erreur EmailJS:', emailError);
                        
                        // Contact ajout√© mais email √©chou√©
                        document.getElementById('messageBox').className = 'message success';
                        document.getElementById('messageBox').innerHTML = `
                            ‚úÖ <strong>CONTACT ${actionText.toUpperCase()} DANS L'ANNUAIRE !</strong><br>
                            üìã ID: <strong>${contactId}</strong><br><br>
                            
                            ‚ö†Ô∏è <strong>Email non envoy√©</strong> (quota EmailJS)<br>
                            üìû <strong>CONTACTEZ MANUELLEMENT :</strong><br>
                            üìß <strong>${email}</strong><br>
                            üë§ <strong>${prenom} ${nom}</strong><br><br>
                            
                            üì± <strong>Message √† envoyer :</strong><br>
                            "Bonjour ${prenom}, votre acc√®s au site de la Troupe Saint Elme a √©t√© accord√© !<br>
                            Niveau: ${permission} | ID: ${contactId}<br>
                            Lien: https://JavaBatchCss.github.io/Troupe-Saint-Elme/site_principal.html<br>
                            Contact: contact.troupesaintelme@gmail.com"
                        `;
                        document.getElementById('messageBox').style.display = 'block';
                        
                        // Auto-masquer apr√®s 15 secondes
                        setTimeout(() => {
                            document.querySelector('.demande-details').style.display = 'none';
                            document.querySelector('.actions').style.display = 'none';
                        }, 15000);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erreur globale validation:', error);
                    
                    // Message d'erreur d√©taill√©
                    document.getElementById('messageBox').className = 'message error';
                    document.getElementById('messageBox').innerHTML = `
                        ‚ùå <strong>√âCHEC AJOUT CONTACT</strong><br>
                        üìã Erreur: <strong>${error.message}</strong><br><br>
                        üîß <strong>V√©rifications √† faire :</strong><br>
                        ‚Ä¢ Configuration GitHub correcte<br>
                        ‚Ä¢ Permissions du token GitHub<br>
                        ‚Ä¢ Fichier contacts.json accessible<br>
                        ‚Ä¢ Connexion internet stable<br><br>
                        üîÑ <strong>R√©essayez dans quelques minutes</strong>
                    `;
                    document.getElementById('messageBox').style.display = 'block';
                    
                    // R√©activer les boutons
                    btnAccepter.disabled = false;
                    btnRefuser.disabled = false;
                    btnAccepter.textContent = originalText;
                }
            });

            document.getElementById('btnRefuser').addEventListener('click', async function() {
                const btnRefuser = document.getElementById('btnRefuser');
                const btnAccepter = document.getElementById('btnAccepter');
                
                btnRefuser.disabled = true;
                btnAccepter.disabled = true;
                btnRefuser.textContent = 'üìß Refus...';
                
                try {
                    const emailContent = buildRefusEmail(nom, prenom, email);
                    
                    const params = {
                        subject: `‚ùå Demande d'acc√®s refus√©e - Troupe Saint Elme`,
                        name: "Troupe Saint Elme",
                        email: email,
                        contenu: emailContent
                    };
                    
                    await emailjs.send('contact_troupe_st_elme', 'Troupe Saint Elme', params);
                    
                    document.getElementById('messageBox').className = 'message success';
                    document.getElementById('messageBox').textContent = "‚úÖ Email de refus envoy√© ! Redirection...";
                    document.getElementById('messageBox').style.display = 'block';
                    
                    setTimeout(() => {
                        window.location.href = window.location.pathname + "?action=refuse";
                    }, 2000);
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erreur EmailJS refus:', error);
                    
                    document.getElementById('messageBox').className = 'message info';
                    document.getElementById('messageBox').innerHTML = `
                        ‚ùå <strong>DEMANDE REFUS√âE</strong><br><br>
                        ‚ö†Ô∏è Email de refus non envoy√© (quota EmailJS)<br>
                        üìû <strong>CONTACTEZ MANUELLEMENT :</strong><br>
                        üìß <strong>${email}</strong> | üë§ <strong>${prenom} ${nom}</strong><br><br>
                        üì± Message de refus √† envoyer via contact.troupesaintelme@gmail.com
                    `;
                    document.getElementById('messageBox').style.display = 'block';
                    
                    setTimeout(() => {
                        document.querySelector('.demande-details').style.display = 'none';
                        document.querySelector('.actions').style.display = 'none';  
                    }, 10000);
                }
            });
        });
        
    </script>

</body>
</html>
</body>
</html>
