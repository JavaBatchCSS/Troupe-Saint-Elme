<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Forum - Troupe Saint Elme</title>
  <link rel="stylesheet" href="https://javabatchcss.github.io/Troupe-Saint-Elme/style.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f7;
      color: #333;
    }

    main {
      padding: 30px;
      max-width: 900px;
      margin: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background-color: #2980b9;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:focus {
      outline: none;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    button:hover {
      background-color: #3498db;
    }

    #messages-list {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }

    .message-item {
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .message-item:hover {
      background: #d0dce3;
    }

    .message-header {
      font-weight: bold;
      color: #2980b9;
    }

    #status {
      margin-top: 15px;
      color: green;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #21618c;
      padding: 12px 30px;
      border-radius: 0 0 10px 10px;
      margin-bottom: 25px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toolbar-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #editor-toolbar {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      padding: 8px;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    #editor-toolbar select, #editor-toolbar input[type="color"] {
      height: 30px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 0 8px;
    }

    #editor-toolbar button {
      min-width: 35px;
      height: 30px;
      padding: 0 8px;
      font-size: 14px;
      background: rgb(255, 255, 255);
      border: 1px solid #ddd;
      color: #333;
    }

    #editor-toolbar button:hover {
      background: #f0f0f0;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .edit-btn, .delete-btn {);
      padding: 6px 12px !important;
      font-size: 18px !important;
      background: transparent !important;
      border: 1px solid #ddd !important;
      border-radius: 4px !important;
      margin: 0 2px !important;
    }

    .edit-btn:hover {
      color: #2980b9 !important;
    }

    .delete-btn:hover {
      color: #e74c3c !important;
    }
  </style>
</head>
<body>

  <header>
    <img style="right:20px" src="https://javabatchcss.github.io/Troupe-Saint-Elme/images/embleme troupe.png" alt="Emblème Troupe Saint Elme">
    <img style="left:20px" src="https://javabatchcss.github.io/Troupe-Saint-Elme/images/logo fédération.png" alt="Logo Fédération">
    <h1>Troupe Saint Elme</h1>
    <nav class="mobile-nav">
       <ul>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/index.html">Accueil</a></li>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/annee_2023.html">2023</a></li>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/annee_2024.html">2024</a></li>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/annee_2025.html">2025</a></li>
            <li style="width: 20px;"></li>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/about-us.html">À Propos</a></li>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/forum.html" class="active">Forum</a></li>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/contact-us.html">Contact</a></li>
            <li><a href="https://javabatchcss.github.io/Troupe-Saint-Elme/documentation.html">Documentation</a></li>
            <li><a href="https://www.fsggb.fr/">Site de la Fédération</a></li>
        </ul>
    </nav>
</header>

  <main>
    <div class="toolbar">
      <div class="toolbar-group">
        <button id="open-message-btn" onclick="showMessageForm()">💬 Envoyer un message</button>
        <button id="sort-btn" onclick="toggleSort()">🔄 Trier: Plus récent</button>
      </div>
      <div class="toolbar-group">
        <input type="text" id="search-bar" placeholder="Rechercher dans les messages..." oninput="filterMessages()" />
      </div>
    </div>

    <div id="message-form" style="display:none;">
      <label for="username">Nom d'utilisateur :</label>
      <input type="text" id="username" placeholder="Votre nom..." />

      <label for="message">Votre message :</label>
      <!-- Barre d'outils de formatage -->
      <div id="editor-toolbar" style="margin-bottom:8px;">
        <select id="font-family" style="margin-right:5px;">
          <option value="Segoe UI">Segoe UI</option>
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
        </select>
        <select id="font-size" style="margin-right:5px;">
          <option value="12px">Très petit</option>
          <option value="14px">Petit</option>
          <option value="16px" selected>Normal</option>
          <option value="18px">Grand</option>
          <option value="22px">Très grand</option>
          <option value="26px">Énorme</option>
        </select>
        <input type="color" id="font-color" value="#333333" style="margin-right:5px;" title="Couleur du texte" />
        <button type="button" onclick="format('bold')" title="Gras"><b>B</b></button>
        <button type="button" onclick="format('italic')" title="Italique"><i>I</i></button>
        <button type="button" onclick="format('underline')" title="Souligné"><u>U</u></button>
        <button type="button" onclick="format('insertUnorderedList')" title="Liste">&#8226; Liste</button>
        <button type="button" onclick="format('insertOrderedList')" title="Liste numérotée">1. Liste</button>
      </div>
      <!-- Zone de saisie riche -->
      <div id="message" contenteditable="true" style="width:100%;min-height:80px;border:1px solid #ccc;border-radius:4px;padding:10px;font-size:14px;background:white;outline:none;"></div>

      <button onclick="submitMessage()">Envoyer</button>
      <button onclick="hideMessageForm()" type="button" style="margin-left:10px;background:#bbb;color:#222;">Annuler</button>
      <p id="status"></p>
    </div>

    <div id="messages-list">
      <h3>📂 Discussions :</h3>
      <div id="messages"></div>
    </div>
  </main>
  <footer>
    <p>&copy; Troupe Saint Elme</p>
</footer>
  <script>
    const repo = 'JavaBatchCSS/Troupe-Saint-Elme';
    const branch = 'master';
    const token = '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'; // ⚠️ Ne jamais exposer publiquement

    const forumFile = 'forum-conversations.json'; // Utilisation d'un fichier JSON

    function showMessageForm() {
      document.getElementById('message-form').style.display = '';
      document.getElementById('open-message-btn').style.display = 'none';
      document.getElementById('status').innerText = '';
      const lastUsername = localStorage.getItem('lastUsername');
      if (lastUsername) {
        document.getElementById('username').value = lastUsername;
      }
    }

    function hideMessageForm() {
      document.getElementById('message-form').style.display = 'none';
      document.getElementById('open-message-btn').style.display = '';
      document.getElementById('username').value = '';
      document.getElementById('message').innerHTML = '';
      document.getElementById('status').innerText = '';
    }

    // Barre d'outils de formatage
    function format(cmd) {
      document.execCommand(cmd, false, null);
    }
    // Appliquer police, taille, couleur
    document.getElementById('font-family').onchange = function() {
      document.execCommand('fontName', false, this.value);
    };
    document.getElementById('font-size').onchange = function() {
      const size = this.value;
      document.execCommand('fontSize', false, '7');
      const selection = document.getSelection().getRangeAt(0);
      selection.commonAncestorContainer.querySelectorAll('font[size]').forEach(el => {
        el.removeAttribute('size');
        el.style.fontSize = size;
      });
    };
    document.getElementById('font-color').onchange = function() {
      document.execCommand('foreColor', false, this.value);
    };

    async function submitMessage() {
      const username = document.getElementById('username').value.trim();
      // Récupère le HTML formaté
      const message = document.getElementById('message').innerHTML;
      const status = document.getElementById('status');

      if (!username || !message || message === "<br>") {
        status.innerText = "Nom d'utilisateur et message sont requis.";
        return;
      }

      // Charger les messages existants (JSON structuré par utilisateur)
      let messagesObj = {};
      try {
        const fileContent = await fetchForumFile();
        messagesObj = JSON.parse(fileContent || '{}');
      } catch (e) {
        messagesObj = {};
      }

      if (!messagesObj[username]) {
        messagesObj[username] = [];
      }
      // Ajout du message HTML formaté
      messagesObj[username].push({
        text: message,
        date: new Date().toISOString()
      });

      const updatedContent = JSON.stringify(messagesObj, null, 2);
      const encodedContent = btoa(unescape(encodeURIComponent(updatedContent)));

      // Sauvegarder le fichier JSON
      const url = `https://api.github.com/repos/${repo}/contents/${forumFile}`;

      // Vérifie si le fichier existe pour récupérer son SHA
      let sha = null;
      try {
        const res = await fetch(url, {
          headers: {
            Authorization: `token ${token}`
          }
        });
        if (res.ok) {
          const data = await res.json();
          sha = data.sha;
        }
      } catch (e) {
        console.log("Fichier inexistant, création en cours.");
      }

      const body = {
        message: sha ? `Mise à jour du forum` : `Création du forum`,
        content: encodedContent,
        branch: branch
      };
      if (sha) body.sha = sha;

      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        localStorage.setItem('lastUsername', username);
        status.innerText = "✅ Message envoyé avec succès.";
        hideMessageForm();
        loadMessages(); // Recharger les messages
        // Réinitialise le contenu éditable
        document.getElementById('message').innerHTML = '';
      } else {
        // Gestion de l'erreur "Bad credentials"
        const error = await res.json();
        if (error && error.message && error.message.toLowerCase().includes("bad credentials")) {
          status.innerText = "❌ Erreur : Problème d'identifiants GitHub (token invalide ou expiré).";
        } else {
          status.innerText = "❌ Erreur : " + (error.message || "Inconnue");
        }
      }
    }

    async function fetchForumFile() {
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${forumFile}`, {
        headers: {
          Authorization: `token ${token}`
        }
      });

      if (res.ok) {
        const file = await res.json();
        return decodeURIComponent(escape(atob(file.content)));
      } else {
        return ''; // Si le fichier n'existe pas, retourner une chaîne vide
      }
    }

    let allMessages = {};
    let sortAscending = true;

    async function loadMessages() {
      let fileContent = await fetchForumFile();
      let messagesObj = {};
      try {
        messagesObj = JSON.parse(fileContent || '{}');
      } catch (e) {
        messagesObj = {};
      }
      allMessages = messagesObj;
      displayMessages(allMessages);
    }

    // Génère une couleur très claire à partir du nom d'utilisateur
    function stringToLightColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      // HSL : teinte variable, saturation faible, luminosité très élevée
      const h = Math.abs(hash) % 360;
      const s = 45 + (Math.abs(hash) % 10); // 45-55%
      const l = 92; // très clair
      return `hsl(${h},${s}%,${l}%)`;
    }

    function displayMessages(messagesObj) {
      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
      // Rassembler tous les messages dans un tableau [{username, text, date, idx}]
      let flatMessages = [];
      Object.entries(messagesObj).forEach(([username, msgs]) => {
        msgs.forEach((msg, idx) => {
          flatMessages.push({
            username,
            text: typeof msg === 'string' ? msg : msg.text,
            date: typeof msg === 'string' ? null : msg.date,
            msgIdx: idx
          });
        });
      });
      // Trier par date selon l'ordre choisi
      flatMessages.sort((a, b) => {
        if (!a.date) return -1;
        if (!b.date) return 1;
        const comparison = new Date(a.date) - new Date(b.date);
        return sortAscending ? comparison : -comparison;
      });
      // Affichage
      flatMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message-item';
        div.style.background = stringToLightColor(msg.username);
        // Format date
        let dateStr = '';
        if (msg.date) {
          const d = new Date(msg.date);
          dateStr = d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' }) +
                    ' ' +
                    d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="message-header" style="color:#21618c">${msg.username}</div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="font-size:12px;color:#888;">${dateStr}</div>
            <div class="action-buttons">
              <button title="Éditer" class="edit-btn" 
                data-username="${encodeURIComponent(msg.username)}" 
                data-msgidx="${msg.msgIdx}">✎</button>
              <button title="Supprimer" class="delete-btn" 
                data-username="${encodeURIComponent(msg.username)}" 
                data-msgidx="${msg.msgIdx}">🗑</button>
            </div>
          </div>
        </div>
        <div style="white-space:pre-line;">${msg.text}</div>`;
        messagesContainer.appendChild(div);
      });

      // Ajout du gestionnaire d'événement pour tous les boutons de suppression
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async function() {
          const username = decodeURIComponent(this.getAttribute('data-username'));
          const msgIdx = parseInt(this.getAttribute('data-msgidx'));
          await deleteMessage(username, msgIdx);
        };
      });

      // Ajout du gestionnaire d'événement pour tous les boutons d'édition
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = async function() {
          const username = decodeURIComponent(this.getAttribute('data-username'));
          const msgIdx = parseInt(this.getAttribute('data-msgidx'));
          await editMessage(username, msgIdx);
        };
      });
    }

    // Suppression d'un message
    async function deleteMessage(username, msgIdx) {
      if (!confirm(`Voulez-vous vraiment supprimer ce message ?\nCette action est irréversible.`)) {
        return;
      }

      try {
        const url = `https://api.github.com/repos/${repo}/contents/${forumFile}`;
        
        // Récupération du fichier et du SHA actuel
        const currentFileRes = await fetch(url, {
          headers: { Authorization: `token ${token}` }
        });
        
        if (!currentFileRes.ok) {
          throw new Error("Impossible d'accéder au fichier.");
        }

        const currentFile = await currentFileRes.json();
        const fileContent = decodeURIComponent(escape(atob(currentFile.content)));
        let messagesObj = JSON.parse(fileContent || '{}');

        if (!messagesObj[username] || !messagesObj[username][msgIdx]) {
          throw new Error("Ce message n'existe plus.");
        }

        // Suppression du message
        messagesObj[username].splice(msgIdx, 1);
        if (messagesObj[username].length === 0) {
          delete messagesObj[username];
        }

        const updateRes = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Suppression d'un message`,
            content: btoa(unescape(encodeURIComponent(JSON.stringify(messagesObj, null, 2)))),
            sha: currentFile.sha,
            branch
          })
        });

        if (!updateRes.ok) {
          const error = await updateRes.json();
          if (error.message.includes('does not match')) {
            throw new Error("Le fichier a été modifié entre temps. Veuillez réessayer.");
          }
          throw new Error("Erreur lors de la mise à jour du fichier.");
        }

        await loadMessages();
        alert("Message supprimé avec succès.");

      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        alert(`Erreur lors de la suppression : ${error.message}`);
      }
    }

    // Ajout de la fonction d'édition
    async function editMessage(username, msgIdx) {
      const messagesObj = JSON.parse(await fetchForumFile() || '{}');
      const message = messagesObj[username]?.[msgIdx];
      
      if (!message) return;
      
      // Afficher le formulaire d'édition
      document.getElementById('message-form').style.display = '';
      document.getElementById('open-message-btn').style.display = 'none';
      document.getElementById('username').value = username;
      document.getElementById('username').disabled = true;
      document.getElementById('message').innerHTML = message.text;
      
      // Changer le bouton d'envoi
      const submitBtn = document.querySelector('#message-form button');
      submitBtn.textContent = 'Modifier';
      submitBtn.onclick = () => submitEdit(username, msgIdx);
    }

    async function submitEdit(username, msgIdx) {
      const newText = document.getElementById('message').innerHTML;
      const messagesObj = JSON.parse(await fetchForumFile() || '{}');
      
      if (messagesObj[username]?.[msgIdx]) {
        messagesObj[username][msgIdx].text = newText;
        
        const updatedContent = JSON.stringify(messagesObj, null, 2);
        const encodedContent = btoa(unescape(encodeURIComponent(updatedContent)));
        
        // Même logique de sauvegarde que pour submitMessage
        const url = `https://api.github.com/repos/${repo}/contents/${forumFile}`;
        let sha = null;
        try {
          const res = await fetch(url, {
            headers: {
              Authorization: `token ${token}`
            }
          });
          if (res.ok) {
            const data = await res.json();
            sha = data.sha;
          }
        } catch (e) {}
        const body = {
          message: `Modification d'un message`,
          content: encodedContent,
          branch: branch
        };
        if (sha) body.sha = sha;
        const res = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (res.ok) {
          document.getElementById('username').disabled = false;
          hideMessageForm();
          loadMessages();
        } else {
          alert("Erreur lors de la modification.");
        }
      }
    }

    function filterMessages() {
      const query = document.getElementById('search-bar').value.toLowerCase();
      // Même logique que displayMessages mais filtré
      let flatMessages = [];
      Object.entries(allMessages).forEach(([username, msgs]) => {
        msgs.forEach(msg => {
          const text = typeof msg === 'string' ? msg : msg.text;
          const date = typeof msg === 'string' ? null : msg.date;
          if (
            username.toLowerCase().includes(query) ||
            (text && text.toLowerCase().includes(query))
          ) {
            flatMessages.push({ username, text, date });
          }
        });
      });
      flatMessages.sort((a, b) => {
        if (!a.date) return -1;
        if (!b.date) return 1;
        const comparison = new Date(a.date) - new Date(b.date);
        return sortAscending ? comparison : -comparison;
      });
      // Affichage filtré
      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
      flatMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message-item';
        div.style.background = stringToLightColor(msg.username);
        let dateStr = '';
        if (msg.date) {
          const d = new Date(msg.date);
          dateStr = d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit' }) +
                    ' ' +
                    d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="message-header" style="color:#21618c">${msg.username}</div>
          <div style="font-size:12px;color:#888;">${dateStr}</div>
        </div>
        <div>${msg.text}</div>`;
        messagesContainer.appendChild(div);
      });
    }

    function toggleSort() {
      sortAscending = !sortAscending;
      document.getElementById('sort-btn').textContent = 
        `🔄 Trier: ${sortAscending ? 'Plus ancien' : 'Plus récent'}`;
      loadMessages();
    }

    loadMessages(); // Chargement initial des messages
  </script>
</body>
</html>
